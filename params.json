{"note":"Don't delete this file! It's used internally to help with page regeneration.","name":"Sp Select","body":"sp_select and sp_select_get_rowcount\r\n====================================\r\nA very hard to crack issue when debugging TSQL Stored procedures on SQL Server 2005, 2008(r2) or \r\n2012 is the fact that you can not see the contents of temp tables outside the session where they \r\nare created. This problem is now solved thanks the procedures `sp_select` and `sp_selectpages`. \r\nThis code would not have been possible without the blog posts from [Fabiano Neves][1] and \r\n[Jonathan Kehayias][2].\r\n\r\nHow to use these procedures\r\n===========================\r\nThe procedures can be deployed on the master database with the included rakefile (or just manually \r\nopen them in SQL Server Management Studio and run them on master)\r\n\r\nOnce they are deployed you can call the procedure `sp_select` from any database. The procedure \r\n`sp_select` accepts the following parameters:\r\n\r\n - @table_name: This is the fully qualified table name to display the contents from. (for example \r\n `msdb.dbo.MSdbms`)\r\n - @spid: this optional parameter can be used to specify a spid on which the temp table is created. \r\n (useful on busy servers)\r\n - @max_pages: this optional parameter is used to limit the amount of data returned. (default 1000)\r\n\r\nTo get the rowcount of the table you can run the procedures `sp_select_get_rowcount` from any \r\ndatabase. The procedure `sp_select_get_rowcount` accepts the following parameters \r\n\r\n - @table_name: This is the fully qualified table name to display the contents from. (for example \r\n `msdb.dbo.MSdbms`)\r\n - @spid: this optional parameter can be used to specify a spid on which the temp table is created. \r\n (useful on busy servers)\r\n \r\nExamples\r\n========\r\nRun the following code in one query window:\r\n\r\n        CREATE TABLE #temp (id int, name varchar(200))\r\n        INSERT INTO #temp VALUES (1, 'Filip')\r\n        INSERT INTO #temp VALUES (2, 'Sam')\r\n \r\nNow open a second query and run the following statement:\r\n\r\n        exec sp_select 'tempdb..#temp'\r\n  \r\nThe result will be\r\n\r\nid | name\r\n---|----------:\r\n1  | Filip\r\n2  | Sam\r\n\r\nWhen you want to see the rowcount you run\r\n\r\n        exec sp_select_get_rowcount 'tempdb..#temp'\r\n\r\nThe result will be\r\n\r\nrows |\r\n------:\r\n2    |\r\n\r\n\r\nHow does it work\r\n================\r\nThe procedure `sp_select` will try to pinpoint the `object_id` of the table you are trying to get \r\nthe data from by calling sp_select_get_object_id. When specifying a permanent table this is quite \r\neasy the function `object_id()` will return the correct value.\r\nWhen the target is a temp table this is quite difficult as SQL Server does not store a link between \r\nthe temp table in tempdb and the session in an easily accessible way. There are 3 scenarios \r\nimplemented in the procedures\r\n\r\n - There is only 1 temp table with the name you are looking for. ==> get the object_id \r\n from `tempdb.sys.tables`\r\n - There are more than 1 temp table with the name you are looking for and you did not specify \r\n a `@spid`. ==> find the first temp table matching the database name of the database you are running \r\n the procedure on\r\n - There are more than 1 temp table with the name you are looking for and you did specify a `@spid` \r\n ==> match the temp table with the spid by mining the default trace file `log.trc`. \r\n\r\nOnce the `object_id` is determined the procedure sp_selectpages will be used to return the content.\r\n\r\n - Use `DBCC IND` to return the list of pages to look at with `DBCC PAGE`\r\n - Loop over all the pages and store the page content with `DBCC PAGE`\r\n - use the PIVOT statement to pivot the key/value results to the original table layout\r\n\r\nNote: All the fields in the resultset will have the type `VARCHAR(6000)`\r\n\r\nThe procedure `sp_select_get_rowcount` will use the same system to pinpoint the `object_id` and will \r\nquery the `sys.dm_db_partition_stats` dmv to get the rowcount. Do note that this view depends on the \r\nstatistics on the table, so the rowcount can be off a bit. If you suspect this is the case, you can\r\nrun `DBCC UPDATEUSAGE (myDatabaseName,\"mySchema.myTable\");` to recalculate the rowcounts. \r\n\r\n[1]: http://mcflyamorim.wordpress.com/2010/05/31/fabiano-vs-dbcc-page/\r\n[2]: http://sqlblog.com/blogs/jonathan_kehayias/archive/2009/09/29/what-session-created-that-object-in-tempdb.aspx\r\n","tagline":"SQL Server TSQL Stored Procedures which enable you to query table data through the data pages directly. This enables you to see the contents of temp tables created on other threads.","google":""}